/**
 * Export Complete Database Schema
 * Script to read database structure from MySQL and export to SQL file
 * Usage: node export-database-schema.js
 */

const mysql = require("mysql2/promise");
const fs = require("fs").promises;
const path = require("path");
require("dotenv").config();

// Database configuration
const dbConfig = {
  host: process.env.DB_HOST || "localhost",
  port: process.env.DB_PORT || 3306,
  user: process.env.DB_USER || "root",
  password: process.env.DB_PASSWORD || "",
  database: process.env.DB_NAME || "company_forum",
};

// Output file
const outputFile = path.join(
  __dirname,
  "database",
  "FULL_DATABASE_SCHEMA_EXPORT.sql"
);

/**
 * Get all tables in database
 */
async function getAllTables(connection) {
  const [tables] = await connection.query("SHOW TABLES");
  return tables.map((row) => Object.values(row)[0]);
}

/**
 * Get CREATE TABLE statement for a table
 */
async function getTableCreateStatement(connection, tableName) {
  const [result] = await connection.query(`SHOW CREATE TABLE \`${tableName}\``);
  return result[0]["Create Table"];
}

/**
 * Get all triggers
 */
async function getAllTriggers(connection) {
  const [triggers] = await connection.query("SHOW TRIGGERS");
  return triggers;
}

/**
 * Get trigger CREATE statement
 */
async function getTriggerCreateStatement(connection, triggerName) {
  const [result] = await connection.query(
    `SHOW CREATE TRIGGER \`${triggerName}\``
  );
  return result[0] ? result[0]["SQL Original Statement"] : null;
}

/**
 * Get all views
 */
async function getAllViews(connection) {
  const [views] = await connection.query(
    `SELECT TABLE_NAME FROM information_schema.TABLES 
     WHERE TABLE_SCHEMA = ? AND TABLE_TYPE = 'VIEW'`,
    [dbConfig.database]
  );
  return views.map((row) => row.TABLE_NAME);
}

/**
 * Get CREATE VIEW statement
 */
async function getViewCreateStatement(connection, viewName) {
  const [result] = await connection.query(`SHOW CREATE VIEW \`${viewName}\``);
  return result[0]["Create View"];
}

/**
 * Get all stored procedures
 */
async function getAllProcedures(connection) {
  const [procedures] = await connection.query(
    `SELECT ROUTINE_NAME FROM information_schema.ROUTINES 
     WHERE ROUTINE_SCHEMA = ? AND ROUTINE_TYPE = 'PROCEDURE'`,
    [dbConfig.database]
  );
  return procedures.map((row) => row.ROUTINE_NAME);
}

/**
 * Get CREATE PROCEDURE statement
 */
async function getProcedureCreateStatement(connection, procedureName) {
  const [result] = await connection.query(
    `SHOW CREATE PROCEDURE \`${procedureName}\``
  );
  return result[0] ? result[0]["Create Procedure"] : null;
}

/**
 * Get table row count and size
 */
async function getTableStats(connection, tableName) {
  const [stats] = await connection.query(
    `SELECT 
      TABLE_ROWS as row_count,
      ROUND((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024, 2) as size_mb
     FROM information_schema.TABLES 
     WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ?`,
    [dbConfig.database, tableName]
  );
  return stats[0];
}

/**
 * Get foreign key relationships
 */
async function getForeignKeys(connection, tableName) {
  const [fks] = await connection.query(
    `SELECT 
      CONSTRAINT_NAME,
      COLUMN_NAME,
      REFERENCED_TABLE_NAME,
      REFERENCED_COLUMN_NAME
     FROM information_schema.KEY_COLUMN_USAGE
     WHERE TABLE_SCHEMA = ? 
       AND TABLE_NAME = ? 
       AND REFERENCED_TABLE_NAME IS NOT NULL`,
    [dbConfig.database, tableName]
  );
  return fks;
}

/**
 * Get indexes for a table
 */
async function getTableIndexes(connection, tableName) {
  const [indexes] = await connection.query(`SHOW INDEX FROM \`${tableName}\``);
  return indexes;
}

/**
 * Main export function
 */
async function exportDatabaseSchema() {
  let connection;

  try {
    console.log("ğŸ”Œ Connecting to database...");
    connection = await mysql.createConnection(dbConfig);
    console.log("âœ… Connected to database:", dbConfig.database);

    let sqlContent = [];

    // Header
    sqlContent.push(
      "-- ================================================================"
    );
    sqlContent.push("-- COMPLETE DATABASE SCHEMA EXPORT");
    sqlContent.push(`-- Database: ${dbConfig.database}`);
    sqlContent.push(`-- Exported: ${new Date().toISOString()}`);
    sqlContent.push(`-- Generated by: export-database-schema.js`);
    sqlContent.push(
      "-- ================================================================\n"
    );

    sqlContent.push(`-- DROP DATABASE IF EXISTS \`${dbConfig.database}\`;`);
    sqlContent.push(
      `-- CREATE DATABASE \`${dbConfig.database}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
    );
    sqlContent.push(`-- USE \`${dbConfig.database}\`;\n`);

    sqlContent.push("SET FOREIGN_KEY_CHECKS = 0;\n");

    // Get all tables
    console.log("\nğŸ“‹ Fetching tables...");
    const tables = await getAllTables(connection);
    console.log(`Found ${tables.length} tables`);

    // Export tables with stats
    sqlContent.push(
      "-- ================================================================"
    );
    sqlContent.push("-- TABLES");
    sqlContent.push(
      "-- ================================================================\n"
    );

    for (const tableName of tables) {
      console.log(`  ğŸ“Š Exporting table: ${tableName}`);

      // Get table stats
      const stats = await getTableStats(connection, tableName);

      // Get foreign keys
      const fks = await getForeignKeys(connection, tableName);

      // Get indexes
      const indexes = await getTableIndexes(connection, tableName);

      // Add table info
      sqlContent.push(`-- Table: ${tableName}`);
      sqlContent.push(
        `-- Rows: ${stats.row_count || 0}, Size: ${stats.size_mb || 0} MB`
      );
      if (fks.length > 0) {
        sqlContent.push(`-- Foreign Keys: ${fks.length}`);
        fks.forEach((fk) => {
          sqlContent.push(
            `--   ${fk.COLUMN_NAME} -> ${fk.REFERENCED_TABLE_NAME}(${fk.REFERENCED_COLUMN_NAME})`
          );
        });
      }
      sqlContent.push("");

      // Get CREATE TABLE statement
      const createStatement = await getTableCreateStatement(
        connection,
        tableName
      );
      sqlContent.push(`DROP TABLE IF EXISTS \`${tableName}\`;\n`);
      sqlContent.push(createStatement + ";\n");
    }

    // Get all views
    console.log("\nğŸ‘ï¸  Fetching views...");
    const views = await getAllViews(connection);
    console.log(`Found ${views.length} views`);

    if (views.length > 0) {
      sqlContent.push(
        "\n-- ================================================================"
      );
      sqlContent.push("-- VIEWS");
      sqlContent.push(
        "-- ================================================================\n"
      );

      for (const viewName of views) {
        console.log(`  ğŸ‘ï¸  Exporting view: ${viewName}`);
        const createStatement = await getViewCreateStatement(
          connection,
          viewName
        );
        sqlContent.push(`DROP VIEW IF EXISTS \`${viewName}\`;\n`);
        sqlContent.push(createStatement + ";\n");
      }
    }

    // Get all triggers
    console.log("\nâš¡ Fetching triggers...");
    const triggers = await getAllTriggers(connection);
    console.log(`Found ${triggers.length} triggers`);

    if (triggers.length > 0) {
      sqlContent.push(
        "\n-- ================================================================"
      );
      sqlContent.push("-- TRIGGERS");
      sqlContent.push(
        "-- ================================================================\n"
      );
      sqlContent.push("DELIMITER $$\n");

      for (const trigger of triggers) {
        console.log(`  âš¡ Exporting trigger: ${trigger.Trigger}`);
        const createStatement = await getTriggerCreateStatement(
          connection,
          trigger.Trigger
        );
        if (createStatement) {
          sqlContent.push(`DROP TRIGGER IF EXISTS \`${trigger.Trigger}\`$$\n`);
          sqlContent.push(createStatement + "$$\n");
        }
      }

      sqlContent.push("DELIMITER ;\n");
    }

    // Get all stored procedures
    console.log("\nğŸ”§ Fetching stored procedures...");
    const procedures = await getAllProcedures(connection);
    console.log(`Found ${procedures.length} stored procedures`);

    if (procedures.length > 0) {
      sqlContent.push(
        "\n-- ================================================================"
      );
      sqlContent.push("-- STORED PROCEDURES");
      sqlContent.push(
        "-- ================================================================\n"
      );
      sqlContent.push("DELIMITER $$\n");

      for (const procedureName of procedures) {
        console.log(`  ğŸ”§ Exporting procedure: ${procedureName}`);
        const createStatement = await getProcedureCreateStatement(
          connection,
          procedureName
        );
        if (createStatement) {
          sqlContent.push(`DROP PROCEDURE IF EXISTS \`${procedureName}\`$$\n`);
          sqlContent.push(createStatement + "$$\n");
        }
      }

      sqlContent.push("DELIMITER ;\n");
    }

    // Footer
    sqlContent.push("\nSET FOREIGN_KEY_CHECKS = 1;\n");
    sqlContent.push(
      "-- ================================================================"
    );
    sqlContent.push("-- END OF EXPORT");
    sqlContent.push(
      "-- ================================================================"
    );

    // Write to file
    console.log("\nğŸ’¾ Writing to file...");
    await fs.writeFile(outputFile, sqlContent.join("\n"), "utf8");

    console.log("\nâœ… Export completed successfully!");
    console.log(`ğŸ“ Output file: ${outputFile}`);
    console.log(`ğŸ“Š Total tables: ${tables.length}`);
    console.log(`ğŸ‘ï¸  Total views: ${views.length}`);
    console.log(`âš¡ Total triggers: ${triggers.length}`);
    console.log(`ğŸ”§ Total procedures: ${procedures.length}`);

    // Generate summary
    const summary = {
      database: dbConfig.database,
      exported_at: new Date().toISOString(),
      tables: tables.length,
      views: views.length,
      triggers: triggers.length,
      procedures: procedures.length,
      output_file: outputFile,
    };

    const summaryFile = path.join(__dirname, "database", "EXPORT_SUMMARY.json");
    await fs.writeFile(summaryFile, JSON.stringify(summary, null, 2), "utf8");
    console.log(`ğŸ“‹ Summary saved to: ${summaryFile}`);
  } catch (error) {
    console.error("âŒ Error exporting database schema:", error.message);
    console.error(error);
    process.exit(1);
  } finally {
    if (connection) {
      await connection.end();
      console.log("\nğŸ”Œ Database connection closed");
    }
  }
}

// Run export
console.log("ğŸš€ Starting database schema export...\n");
exportDatabaseSchema();
